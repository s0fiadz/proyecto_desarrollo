{% extends "core/base.html" %}

{% block content %}
<div class="container mt-4" style="max-width: 850px;">

    <h4 class="mb-4 text-center fw-bold">Editar Encuesta</h4>

    {% if error %}
        <div class="alert alert-danger text-center">{{ error }}</div>
    {% endif %}

    {% if encuesta.activo %}
        <div class="alert alert-warning text-center">
            Esta encuesta está <strong>activa</strong> y no puede ser editada.  
            Debe bloquearla antes de modificarla.
        </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-body p-4">
            <form method="post" action="{% url 'encuesta_edit' encuesta.id_encuesta %}">
                {% csrf_token %}

                <h5 class="mb-3 text-primary-emphasis border-bottom pb-2">Datos de la Encuesta</h5>

                <div class="mb-3">
                    <label class="form-label fw-bold">Título:</label>
                    <input type="text" name="titulo" class="form-control"
                           value="{{ encuesta.titulo }}" required
                           {% if encuesta.activo %}disabled{% endif %}>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Tipo de Incidencia:</label>
                    <select name="tipo_incidencia" class="form-select" required
                            {% if encuesta.activo %}disabled{% endif %}>
                        {% for tipo in tipos_incidencia %}
                            <option value="{{ tipo.id_tipo }}"
                                {% if tipo.id_tipo == encuesta.id_tipo_incidencia.id_tipo %}selected{% endif %}>
                                {{ tipo.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Descripción:</label>
                    <textarea name="descripcion" class="form-control" rows="4"
                              {% if encuesta.activo %}disabled{% endif %}>{{ encuesta.descripcion }}</textarea>
                </div>

                <div class="form-check mb-4">
                    <input type="checkbox" class="form-check-input" name="activo" id="activoCheck"
                           {% if encuesta.activo %}checked{% endif %}
                           {% if encuesta.activo %}disabled{% endif %}>
                    <label class="form-check-label" for="activoCheck">Encuesta activa</label>
                </div>

                <h5 class="mb-3 mt-4 text-primary-emphasis border-bottom pb-2">Preguntas de la Encuesta</h5>

                <div id="preguntas-container">
                    {% for pregunta in preguntas %}
                    <div class="pregunta-item input-group mb-2">
                        <input type="hidden" name="ids_preguntas[]" value="{{ pregunta.id_preguntas }}" />

                        <input type="text" name="preguntas_existentes[]"
                               class="form-control"
                               value="{{ pregunta.pregunta }}"
                               placeholder="Ingrese una pregunta" required
                               {% if encuesta.activo %}disabled{% endif %}>

                        {% if not encuesta.activo %}
                        <a href="{% url 'eliminar_pregunta' pregunta.id_preguntas %}"
                           onclick="return confirm('¿Está seguro de que desea eliminar esta pregunta?')"
                           class="btn btn-outline-danger">✕</a>
                        {% endif %}
                    </div>
                    {% endfor %}

                    {% if not encuesta.activo %}
                    <div class="pregunta-item input-group mb-2">
                        <input type="text" name="nuevas_preguntas[]"
                               class="form-control"
                               placeholder="Agregar nueva pregunta (opcional)">
                        <button type="button" class="btn btn-outline-danger" onclick="eliminarPregunta(this)">✕</button>
                    </div>
                    {% endif %}
                </div>

                {% if not encuesta.activo %}
                <button type="button" class="btn btn-info text-white mt-2" onclick="agregarPregunta()">
                    + Agregar otra pregunta
                </button>

                <div class="mt-4">
                    <button type="submit" class="btn btn-info text-white">Guardar Cambios</button>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <div class="mt-3 mb-5">
        <a href="{% url 'encuesta_list' %}" class="btn btn-secondary">Volver a Encuestas</a>
    </div>
</div>

{% if not encuesta.activo %}
<script>
function agregarPregunta() {
    const container = document.getElementById('preguntas-container');
    const newDiv = document.createElement('div');
    // Usamos las clases de Bootstrap 'input-group' y 'mb-2' para alineación
    newDiv.className = 'pregunta-item input-group mb-2';

    newDiv.innerHTML = `
        <input type="text" name="nuevas_preguntas[]" class="form-control"
                placeholder="Agregar nueva pregunta" required />
        <button type="button" class="btn btn-outline-danger" onclick="eliminarPregunta(this)">✕</button>
    `;

    container.appendChild(newDiv);
}

function eliminarPregunta(button) {
    // Buscamos por la clase .pregunta-item para contar cuántas hay
    const preguntas = document.querySelectorAll('.pregunta-item');
    if (preguntas.length > 1) {
        button.parentElement.remove(); // Elimina el div completo (input-group)
    } else {
        alert('Debe haber al menos una pregunta');
    }
}
</script>
{% endif %}
{% endblock %}