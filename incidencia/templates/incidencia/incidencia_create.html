{% extends 'incidencia/base_territorial.html' %}
{% load static %}

{% block content %}
<div class="container mt-4" style="max-width: 800px;">
    
    <h4 class="mb-4 text-center fw-bold">Crear Nueva Incidencia</h4>

    {% if error %}
        <div class="alert alert-danger text-center">
            <strong>Error:</strong> {{ error }}
        </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-body p-4">
            
            <form method="post" action="{% url 'incidencia:incidencia_create' %}" enctype="multipart/form-data">
                {% csrf_token %}
                
                <h5 class="text-primary-emphasis border-bottom pb-2 mb-3">Datos de la Incidencia</h5>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Departamento</label>
                        <select name="departamento" class="form-select" required>
                            <option value="">Seleccione un departamento</option>
                            {% for dpto in departamentos %}
                                <option value="{{ dpto.id }}">{{ dpto.nombre_dpto }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Encuesta Asociada</label>
                        <select name="id_encuesta" id="id_encuesta" class="form-select" required onchange="cargarPreguntas()">
                            <option value="">Seleccione una encuesta</option>
                            {% for encuesta in encuestas %}
                            <option value="{{ encuesta.id_encuesta }}">{{ encuesta.titulo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Descripción</label>
                    <textarea name="descripcion" class="form-control" rows="3" placeholder="Descripción de la incidencia" required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Dirección del Incidente</label>
                    <input type="text" name="direccion_incidente" class="form-control" placeholder="Dirección del incidente" required />
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Lateral</label>
                        <input type="text" name="lateral" class="form-control" placeholder="Opcional" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Longitud</label>
                        <input type="text" name="longitud" class="form-control" placeholder="Opcional" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Prioridad</label>
                        <select name="prioridad" class="form-select" required>
                            <option value="">Seleccione</option>
                            <option value="baja">Baja</option>
                            <option value="media" selected>Media</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                </div>

                <h5 class="text-primary-emphasis border-bottom pb-2 mb-3 mt-4">Datos del Vecino</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Nombre</label>
                        <input type="text" name="nombre_vecino" class="form-control" required />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Apellido</label>
                        <input type="text" name="apellido_vecino" class="form-control" required />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Correo</label>
                        <input type="email" name="correo_vecino" class="form-control" placeholder="Opcional" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">RAT</label>
                        <input type="text" name="rat" class="form-control" placeholder="Opcional" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Dirección del Vecino</label>
                    <input type="text" name="direccion_vecino" class="form-control" required />
                </div>

                <h5 class="text-primary-emphasis border-bottom pb-2 mb-3 mt-4">Preguntas de la Encuesta</h5>
                
                <div id="preguntas-container" class="p-3 bg-light rounded border mb-3">
                    <p class="text-muted text-center mb-0">Seleccione una encuesta arriba para cargar las preguntas.</p>
                </div>

                <h5 class="text-primary-emphasis border-bottom pb-2 mb-3 mt-4">Archivos Multimedia</h5>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Adjuntar Evidencia</label>
                    <input type="file" name="archivos_multimedia" class="form-control" multiple />
                    <div class="form-text">Puede seleccionar múltiples archivos (Imágenes, PDF, etc).</div>
                </div>
                
                <div class="mb-4">
                    <label class="form-label fw-bold">Descripción de Archivos</label>
                    <textarea name="descripcion_archivo" class="form-control" rows="2" placeholder="Opcional"></textarea>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-info text-white btn-lg">Crear Incidencia</button>
                </div>
            </form>

        </div>
    </div>

    <div class="text-center mt-4 mb-5">
        <a href="{% url 'incidencia:main_territorial' %}" class="btn btn-secondary">
            Volver al listado de incidencias
        </a>
    </div>
</div>

<script>
function cargarPreguntas() {
    const encuestaId = document.getElementById('id_encuesta').value;
    const container = document.getElementById('preguntas-container');
    
    if (!encuestaId) {
        container.innerHTML = '<p class="text-muted text-center mb-0">Seleccione una encuesta para cargar las preguntas</p>';
        return;
    }
    
    // Se añade un spinner o texto de carga
    container.innerHTML = '<p class="text-center text-muted">Cargando preguntas...</p>';

    fetch(`{% url 'incidencia:get_preguntas' %}?id_encuesta=${encuestaId}`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                let html = '';
                data.forEach(pregunta => {
                    // Generamos HTML con clases de Bootstrap para que se vea integrado
                    html += `
                        <div class="mb-3">
                            <label class="form-label fw-bold">${pregunta.pregunta}</label>
                            <textarea name="respuesta_${pregunta.id_preguntas}" class="form-control" rows="2" placeholder="Ingrese su respuesta" required></textarea>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="alert alert-warning">Esta encuesta no tiene preguntas definidas.</div>';
            }
        })
        .catch(() => {
            container.innerHTML = '<div class="alert alert-danger">Error al cargar las preguntas. Intente nuevamente.</div>';
        });
}
</script>

{% endblock %}